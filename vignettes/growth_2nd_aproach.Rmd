---
title: "plot_growth_wells"
author: "Martin"
date: "4/2/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ggplot2)
library(dplyr)
library(signal)
```

```{r}
#Read data
sp_data <- mpxtractor::read_spectramax_data(file = "../spectraMAx/data/20190701_growthrates_mg1363_pt2_smA_2ndplate.txt")
sp_data_layout <- mpxtractor::read_layout_files(sp_data, reader_type = "spectramax", layout_files = "../spectraMAx/data/20190611_growthrates_biolog_layout_plate2.csv")
```

```{r}
# Time in hs
get_time_in_hh <- function(time.col){
 sapply(strsplit(time.col, ":"), function(x) {
        x <- as.numeric(x)
        if (length(x) <= 2) {
          x[1]/60 + x[2]/3600
        }
        else {
          x[1] + x[2]/60 + x[3]/3600
        }
 })
}

Time_HH <- get_time_in_hh(sp_data$`Time(hh:mm:ss)`)

# Move column time to the front
sp_data_layout <- cbind(Time_HH, sp_data_layout)

# Clean the dataframe
sp_tidy_data <- sp_data_layout %>%
   select(c(-`Time(hh:mm:ss)`, -`Temperature(°C)`, -Plate))

sp_data_sample <- sp_tidy_data

```

```{r}
#### background correction - taking minimum value of each well
sp_data_sample <- sp_data_sample %>%
  group_by(Wells) %>%
  mutate(min_measurement = min(Measurement))

sp_data_sample$bg_corrected <- (sp_data_sample$Measurement - sp_data_sample$min_measurement)

```


```{r}
# Calculate the dt
sp_data_sample<- sp_data_sample %>%
  mutate(Diff_time = Time_HH[2] - Time_HH[1])
# log transform of bg corrected measurements
sp_data_sample$log_measurement <- log(sp_data_sample$Measurement)
```

# Smooth the data using Savitzky and Golay filter(savgol). Low pass filter.
When applying SG, we select a moving average window with an odd value “n” for the number of data points. SG fit a polynomial of “p” degree to this data points and give the value to the central point (this is the reason to have an odd value).
We apply also an smooth in the case of “m” = 0, or the first (m=1), second (m=2) or third (m=3) derivatives.
```{r}
windowsize <- 2 #hs
timestep <- 2/60 # hs
windowlength = (windowsize /sp_data_sample$Diff_time[2])

if ((windowlength %% 2) == 0) {
 windowlength <- windowlength + 1
}
sg0 <- sp_data_sample %>%
  group_by(Wells) %>%
  group_map(~ sgolayfilt(.x$log_measurement,
    p = 1,
    n = windowlength,
    m = 0,
    ts = timestep
  ))
sp_data_sample$sg0 <- as.vector(unlist(sg0))

mu <- sp_data_sample %>%
  group_by(Wells) %>%
  group_map(~ sgolayfilt(.x$log_measurement,
    p = 1,
    n = windowlength,
    m = 1,
    ts = timestep
  ))

sp_data_sample$mu <- as.vector(unlist(mu))


```

```{r}
t <- sp_data_sample %>%
  dplyr::filter(Wells == c("B01","B02","B03","B04","C01","C02","C03","C04", "D01","D02","D03","D04"))

ggplot(data = t, aes(x = Time_HH, y = log_measurement )) + geom_point() +
    facet_wrap(~Wells, drop = FALSE, ncol = 4) +
    geom_point(aes(colour = condition ), size = 1)

```




```{r}
t <- sp_data_sample %>%
  dplyr::filter(Wells == c("B01","B02","B03","B04","C01","C02","C03","C04", "D01","D02","D03","D04"))

ggplot(data = t, aes(x = Time_HH, y = mu)) +
  geom_point() +
  facet_wrap(~Wells, drop = FALSE, ncol = 4) +
  geom_point(aes(colour = condition), size = 1) +
  theme_bw() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    strip.background = element_blank(),
    panel.border = element_rect(colour = "white")
  )

        
```


```{r}
t <- sp_data_sample %>%
  dplyr::filter(Wells == c("B01","B02","B03","B04","C01","C02","C03","C04", "D01","D02","D03","D04", "E01","E02","E03","E04", "F01","F02","F03","F04","G01","G02","G03","G04"))

ggplot(data = t, aes(x = Time_HH, y = mu)) + geom_point() +
    facet_wrap(~Wells, drop = FALSE, ncol = 4) +
    geom_point(aes(colour = condition ), size = 1)+
   theme_bw() +
        theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        panel.border = element_rect(colour = "white"))

```

