---
title: "plot_wells_plots"
author: "Martin"
date: "4/6/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#library(plyr)
library(dplyr)
library(ggplot2)
library(signal)
library(tidyverse)
library(purrr)
library(imputeTS)
library(viridis)

```

#Read data
```{r}
sp_data <- mpxtractor::read_spectramax_data(file = "../inst/extdata/spectraMax_2ndplate.txt")
sp_data_layout <- mpxtractor::read_layout_files(sp_data, reader_type = "spectramax", layout_files = "../inst/extdata/spectraMax_layout_plate2.csv")
```


```{r}
# Time in hs
get_time_in_hh <- function(time.col){
 sapply(strsplit(time.col, ":"), function(x){
        x <- as.numeric(x)
        if (length(x) <= 2) {
          x[1]/60 + x[2]/3600
        }
        else {
          x[1] + x[2]/60 + x[3]/3600
        }
 })
}

Time_HH <- get_time_in_hh(sp_data$`Time(hh:mm:ss)`)

# Move column time to the front
sp_data_layout <- cbind(Time_HH, sp_data_layout)

# Clean the dataframe
sp_tidy_data <- sp_data_layout %>%
   select(c(-`Time(hh:mm:ss)`, -`Temperature(Â°C)`, -Plate))


```

#### background correction - taking minimum value of each well
```{r}
sp_data_sample <- sp_tidy_data %>%
  dplyr::group_by(Wells) %>%
  dplyr::mutate(min_measurement = min(Measurement))

sp_data_sample$bg_corrected <- (sp_data_sample$Measurement - sp_data_sample$min_measurement)
# log transform of bg corrected measurements
sp_data_sample$log_measurement <- log(sp_data_sample$bg_corrected)
#replace -inf by NA
is.na(sp_data_sample$log_measurement) <- sapply(sp_data_sample$log_measurement, is.infinite)

# impute data
sp_data_sample$log_measu_impute <- na_ma(sp_data_sample$log_measurement, k = 1)

mean_impute <- function(x){
ifelse(is.na(x), mean(x, na.rm = T),x)
}


# Calculate the dt
sp_data_sample <- sp_data_sample %>%
  mutate(Diff_time = Time_HH[2] - Time_HH[1])
```


```{r}
windowsize <- 2 #hs
timestep <- 2/60 # hs
windowlength = (windowsize /sp_data_sample$Diff_time[2])

if ((windowlength %% 2) == 0) {
 windowlength <- windowlength + 1
}

```


# Calculate growth rate (mu) using Savitzky and Golay filter(savgol).
```{r}
mu <- sp_data_sample %>%
  group_by(Wells) %>%
  group_map(~ sgolayfilt(.x$log_measu_impute,
    p = 1,
    n = windowlength,
    m = 1,
    ts = timestep
  ))

sp_data_sample$mu <- as.vector(unlist(mu))

```


Generate subplots
```{r}
sp_data_sample$condition_fc <- factor(sp_data_sample$condition,
  levels = unique(sp_data_sample$condition)
)
# generte color scale
colors_fact <- rev(viridis(length(unique(sp_data_sample$condition))))
names(colors_fact) <- levels(sp_data_sample$condition_fc)
colScale <- scale_colour_manual(name = "condition_fc", values = colors_fact)

# generate subplots
sub_plots <- sp_data_sample %>%
  group_by(Wells) %>%
  do(subplots = ggplot(., aes(x = Time_HH, y = mu)) +
    geom_line(aes(colour = condition_fc), size = 1) +
    colScale +
    theme_void() +
    theme(
      legend.position = "none",
      panel.border = element_rect(colour = "black", fill = NA, size = 0.5)
    ))


sub_plots$subplots[1]

```




# Add column and row to the table sub_subplots
```{r}
platemap <- dplyr::mutate(sub_plots,
                            Row = as.numeric(match(toupper(substr(Wells, 1, 1)),
                                                   LETTERS)),
                            Column = as.numeric(substr(Wells, 2, 5)))

platemap$Row <- rev(platemap$Row)

```


# Function cut_into_coordinates() to generate the coordinates x-y for each subplot.
```{r}
cut_into_coordinates <- function(variable, ngroups) {
  seq_all <- seq(min(variable) - 0.5, max(variable) + 0.5, by = 1)
  cut(variable,
    breaks = seq_all,
    labels = paste(seq_all[-(ngroups + 1)], seq_all[-1], sep = ","),
    include.lowest = TRUE
  )
}

platemap$group_x = cut_into_coordinates(platemap$Column, 24)
platemap$group_y = cut_into_coordinates(platemap$Row, 16) 

platemap_min_max <- platemap %>%
  separate(group_x,
    into = c("min_x", "max_x"),
    sep = ",", convert = TRUE
  ) %>%
  separate(group_y,
    into = c("min_y", "max_y"),
    sep = ",", convert = TRUE
  )
```

# Function grobfun() generate the graphical objects with the coordinates x-y to plot
in the background plot.

```{r}
grobfun = function(min_x, max_x, min_y, max_y, subplots) {
     annotation_custom(ggplotGrob(subplots),
                       xmin = min_x, ymin = min_y,
                       xmax = max_x, ymax = max_y)
}

```


```{r}
allgrobs <- platemap_min_max %>%
     select(min_x, max_x, min_y, max_y, subplots) %>%
     mutate(grobs = pmap(., grobfun)) 

```

```{r}
platemap <- inner_join(platemap_min_max,
  unique(sp_data_sample[, c("Wells", "condition_fc")]),
  by = "Wells"
)

```


```{r}
color_con <- stack(colors_fact)

n_col <- length(unique(platemap$Column))
n_row <- length(unique(platemap$Row))


background_plot <- ggplot2::ggplot(data = platemap, aes(x = Column, y = Row, fill = condition_fc)) +
  geom_blank() +
  theme_classic() +
  theme(panel.border = element_rect("transparent")) +
  scale_x_continuous(breaks = seq(1, n_col), position = "top") +
  scale_y_continuous(breaks = seq(1, n_row), labels = LETTERS[n_row:1] ,position = "left") +
  geom_col( aes(Inf, Inf) ) +
  scale_fill_manual(name = "condition", values = color_con$values) +
  labs(title = "Growth rate")
  
allwells <-  background_plot + allgrobs$grobs  


ggsave(path = "../inst/extdata/","plot_gr_microplate.png", plot = allwells, width = 30, height = 20, units = "cm")

```

```{r}
mpxtractor::microplate_spectramax_gr_plot(spectramax_data = "../inst/extdata/spectraMax_2ndplate.txt", layout_file = "../inst/extdata/spectraMax_layout_plate2.csv",exp_title = "spectramax experiment 1",windowsize = 2, var_to_col = "Condition")

```





